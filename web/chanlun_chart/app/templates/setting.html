<!DOCTYPE HTML>
<html lang="zh">

<head>
    <title>系统设置</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layui.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
    <script type="text/javascript" src="{{ url_for('static', filename='layui.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='jquery-3.7.0.min.js') }}"></script>
    {% include 'dark.html' %}
</head>

<body class="layui-fluid">

    <form class="layui-form layui-row setting_form" lay-filter="setting_form" role="form" style="padding: 20px;">

        <div class="layui-form-item">
            <label class="layui-form-label">钉钉 Token</label>
            <div class="layui-input-block" title="钉钉Token">
                <div class="layui-input-block">
                    <input type="text" name="dd_token" value="{{ dd_token }}" placeholder="请输入 钉钉Token"
                        autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">钉钉 Secret</label>
            <div class="layui-input-block" title="钉钉Token">
                <div class="layui-input-block">
                    <input type="text" name="dd_secret" value="{{ dd_secret }}" placeholder="请输入 钉钉Token"
                        autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">代理 Host</label>
            <div class="layui-input-block" title="代理 Host">
                <div class="layui-input-block">
                    <input type="text" name="proxy_host" value="{{ proxy_host }}" placeholder="请输入 代理 Host"
                        autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">代理 Port</label>
            <div class="layui-input-block" title="代理 Port">
                <div class="layui-input-block">
                    <input type="text" name="proxy_port" value="{{ proxy_port }}" placeholder="请输入 代理 Port"
                        autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>


        <div class="layui-form-item">
            <button class="layui-btn layui-btn-fluid layui-bg-red" lay-submit lay-filter="setting_save">保存</button>
        </div>
    </form>

    <blockquote class="layui-elem-quote layui-quote-nm">
        <h3>设置说明：</h3>
        <p>行情监控任务，如有警报，并且配置了钉钉的 Token与 Secret 则会发送钉钉消息；</p>
        <p>代理服务器，如果看数字货币行情，则无需进行设置；</p>
        <h3>钉钉配置获取方式：</h3>
        <div>
            <ol>
                <li>
                    下载手机版与电脑版 钉钉，并登录
                </li>
                <li>
                    在手机版【发起群聊】，选择【面对面建群】，密码随便输入即可
                </li>
                <li>
                    在电脑端找到刚刚在手机端创建的群，选择【群设置】 -> 【机器人】 -> 【添加机器人】
                </li>
                <li>
                    在 【添加机器人】页面选择 【自定义】
                </li>
                <li>
                    机器人名字可以自定义，安全设置中，勾选 【加签】，复制保存，这个就是项目中要用到的 钉钉Secret 字段
                </li>
                <li>
                    添加完成后，会出现 Webhook 字段展示，类似：https://oapi.dingtalk.com/robot/send?access_token=c94d7***
                </li>
                <li>
                    链接中 access_token= 后面的内容：c94d7***，就是项目中要用到的 钉钉Token 字段
                </li>
                <li>
                    之后将 钉钉Token 与 钉钉Secret 复制到 设置中，进行保存即可
                </li>
                <li>
                    <a href="https://open.dingtalk.com/document/robots/custom-robot-access"
                        target="_blank">自定义机器人接入文档</a>
                </li>
            </ol>
        </div>
    </blockquote>

    <script>
        $(function () {
            layui.use(function () {
                const form = layui.form;
                const layer = layui.layer;
                // 提交事件
                form.on('submit(setting_save)', function (data) {
                    // data = form.val('setting_form');
                    console.log(data.field);
                    $.ajax({
                        type: "POST",
                        url: "/setting/save",
                        data: data.field,
                        dataType: 'json',
                        traditional: true,
                        success: function (result) {
                            if (result['ok'] === true) {
                                layer.msg('配置保存成功');
                            } else {
                                layer.msg('配置保存失败');
                            }
                        }
                    });
                    return false; // 阻止默认 form 跳转
                });
            });
        });


    </script>
</body>

</html>